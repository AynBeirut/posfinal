// Script to bundle all migration SQL files into a single JavaScript file
const fs = require('fs');
const path = require('path');

const migrations = [
    { num: 1, file: '001-initial-schema.sql', desc: 'Initial schema with all 8 core tables + sync_queue + system_settings' },
    { num: 2, file: '002-enhanced-features.sql', desc: 'Add phonebook, bill_payments, bill_types, company_info, app_settings' },
    { num: 3, file: '002-phonebook-enhancements.sql', desc: 'Enhanced phonebook with categories, birthday, balance, notes, and history' },
    { num: 4, file: '003-add-product-cost.sql', desc: 'Add cost column to products table for weighted average cost tracking' },
    { num: 5, file: '004-fix-suppliers-autoincrement.sql', desc: 'Fix AUTOINCREMENT for suppliers, deliveries, delivery_items, supplier_payments tables' },
    { num: 6, file: '005-add-product-type.sql', desc: 'Add type column to products table (item/service) and service-specific fields' },
    { num: 7, file: '006-update-service-types.sql', desc: 'Update existing service products to correct type and hourly rates' },
    { num: 8, file: '007-add-cash-shifts.sql', desc: 'Add cash drawer shift management and bank transfer tables' },
    { num: 9, file: '008-add-refunds.sql', desc: 'Add refunds table and order modification tracking' },
    { num: 10, file: '009-add-users-isActive.sql', desc: 'Add isActive column to users table for user status management' },
    { num: 11, file: '011-add-receipt-numbering.sql', desc: 'Add sequential receipt numbering system (SALE-000001, REF-000001)' },
    { num: 12, file: '012-future-features-placeholders.sql', desc: 'Add future features: raw materials, recipes, staff, approvals, expenses, dining areas' },
    { num: 13, file: '013-multi-currency-system.sql', desc: 'Add multi-currency support with exchange rates and conversion tracking' },
    { num: 14, file: '014-discount-offers-system.sql', desc: 'Add discount rules, loyalty tiers, and promotional codes system' },
    { num: 15, file: '015-add-raw-materials.sql', desc: 'Add raw materials support with unit types and decimal stock quantities' },
    { num: 16, file: '016-add-refund-tracking.sql', desc: 'Add refund tracking columns and update stock_history to support refund type' },
    { num: 17, file: '017-supplier-client-financial-tracking.sql', desc: 'Add payment terms, balance caching, visit tracking, and configurable settings' },
    { num: 18, file: '018-add-product-recipes.sql', desc: 'Add recipe system for composed products with ingredient tracking and cost snapshots' },
    { num: 19, file: '019-partial-payments.sql', desc: 'Add partial payment support with down payments and balance tracking' }
];

let output = `// AUTO-GENERATED BUNDLED MIGRATIONS
// Generated: ${new Date().toISOString()}
// DO NOT EDIT THIS FILE MANUALLY - Run bundle-migrations.js to regenerate

const BUNDLED_MIGRATIONS = {\n`;

migrations.forEach(mig => {
    const filePath = path.join(__dirname, mig.file);
    if (fs.existsSync(filePath)) {
        const content = fs.readFileSync(filePath, 'utf8')
            .replace(/\\/g, '\\\\')
            .replace(/`/g, '\\`')
            .replace(/\$/g, '\\$');
        
        output += `    ${mig.num}: {
        version: ${mig.num},
        description: '${mig.desc}',
        sql: \`${content}\`
    },\n`;
    } else {
        console.warn(`Warning: ${mig.file} not found`);
    }
});

output += `};

// Export for use in db-sql.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = BUNDLED_MIGRATIONS;
}
`;

const outputPath = path.join(__dirname, '../js/migrations-bundle.js');
fs.writeFileSync(outputPath, output, 'utf8');
console.log(`âœ… Created ${outputPath}`);
console.log(`   Size: ${Math.round(output.length / 1024)} KB`);
